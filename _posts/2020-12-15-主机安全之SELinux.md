---
layout:     post             
title:      主机安全之SELinux    
subtitle:   增强型linux         
date:       2020-12-15             
author:     suleo                  
head-img:   img/post-bg-keybord.jpg    
catalog: true                      
tags:                              
    - 日常工具    
---  

# 主机安全之SELinux理论部分

## 一、主机安全简介

> 主机安全核心内容应包括应用交付系统、应用监管系统、安全增强操作系统和运维安全管控系统。具体功能是为了保障主机在数据存储和处理的保密性、完整性和可用性，它包括硬件、固件、系统软件的自身安全以及一系列附加的安全技术与安全管理措施，从而建立一个完整的主机安全的环境。



#### 1. 基础功能应包括以下

1. 系统安全基线 （一个操作系统最小的安全保证）
2. 强制访问控制 （对系统上资源配置不同访问策略加以保护）
3. 防格式化保护机制 （防止病毒或入侵者格式化磁盘）
4. 完整性检测（检测文件改变异常时应告警）
5. 系统资源监控 （对系统cpu、内存、磁盘、网络资源进行监控，超过阈值报警）
6. 双因子认证 （usb-key + 密码）
7. 日志审计 （记录尽可能详尽的违规日志、用户操作日志并上传到专用日志服务器）
8. 关键事件 （定义严重时间特征，触发马上告警）
9. 设备统一管理机制 （提高管理效率）
10. 策略模板 （指定分等级的安全策略模板，降低用户维护难度）
11. 信息收集 （对用户使用过程提出的疑问，集中探讨并解决）
12. 维护模式 （此时配置的策略只记录，不拦截，以防止配错策略造成业务中断）
13. 内部人员安全意识培训

#### 2. 价值功能如下

1. 免疫木马病毒，从文件的创建执行到访问资源到结束层层把关，从根本免疫各种已知未知病毒、后门等恶意代码，确保系统和应用的安全
2. 抵御0day, 才用白名单和强制访问控制，只允许可信账户与进程访问被保护资源，并对重要二进制文件实行完整性保护，即使用户找到突破口，影响能被控制在最小范围
3. 分权管理，才用分权管理机制，避免单用户权限独大，将原系统管理员权限分为系统操作员、安全管理员与审计管理员，三个管理用户各司其职，相互制约
4. 提升系统安全级别，系统在操作系统内核实现安全标记和系统级强制访问控制，与用户系统自身的自主访问控制相融合，为系统和用户重要应用提供更强的约束和更高级别的安全控制
5. 系统暴露的高危漏洞，漏洞是攻击者发起攻击的最有效方法，最有效的方法就是保持与厂商同步的最新更新
6. 入侵检测系统，所有用户一视同仁，没有超级用户的概念，监控主机进程与文件并提供细化的权限分配接口



## 二、SELinux （Security-Enhanced Linux）

> SELinux是美国国家安全局对强制访问控制的实现，centos7中已经默认安装 ，是目前功能最全面，测试最充分的linux安全模块，基于域 (所有进程和文件都用类型标记，类型定义进程的域) 的强制访问控制模型，他会在自主访问控制（现有的基于用户的）策略之后生效，对系统所有进程和文件实施由管理人员设置的安全策略，从而限制了可能因系统或应用漏洞而导致的潜在损害范围。

![IMG_9338](https://raw.githubusercontent.com/BigTree975/BigTree975.github.io/master/img/selinux1.PNG)

#### 1. 术语解释

- 主体：selinux中通常指的是进程

- 客体：用于信息共享、存储和通讯的系统资源（如文件、目录、套接字、共享内存等）

  ​			一个客体类别代表某个确定类型（文件或套接字）的所有资源

  ​            一个客体类别的实例（该类型的某个特定文件）被称为一个客体（如/etc/passwd这个文件）

- DAC/MAC

  - DAC (discretionary access control)，自主访问控制，根据权限位+ACL设置访问权限，特点是基于用户标识的访问控制，如一个文件，文件所有者，同组用户，其它组用户。
  - MAC (mandatory access control)，强制访问控制，用户（或其他主体）与文件（或其他客体）都被标记了固定的安全属性（如安全级、访问权限等），在每次访问发生时，系统检测安全属性以便确定一个用户是否有权访问该文件

- AV/AVC

  - AV (Access vectors),用来表示策略的规则，如允许域访问各种系统客体，一个AV是一套许可。一个基本的AV规则是主体和客体的类型对，AV规则语法如下

    ```
    <av_kind><source_type(s)><target_type(s)>:<class(es)>
    <permission(s)>
    ```

    <av_kind>有四种设置：

    - allow，表示允许主体对客体执行允许的操作；
    - neverallow，表示不允许主体对客体执行指定的操作;
    - auditallow，表示允许操作并记录访问决策信息;
    - dontaudit，表示不记录违反规则的决策信息，且违反规则不影响运行;

    Allow规则由四部分组成：

    - 源类型(Source type(s))是尝试访问进程的域类型；
    - 目标类型(Target type(s))被进程访问的客体的类型；
    - 客体类别(Object class(es))是指定允许访问的客体的类型，如 file,dir,socket 等；
    - 许可(Pemission(s))象征目标类型允许源类型访问客体类型的访问种类。

    AV 的例子如下:

    ```
    allow init_t apache_exec_t : file execute;
    allow userdomain shell_exec_t: file{ read getattr lock execute ioctl};
    # 拥有域类型user_t的进程可以读／执行或获取具体有bin_t类型的文件客体的属性
    allow user_t bin_t:file {read execute getattr}
    ```

  - AVC 提供了从安全服务器获得的访问策略的缓冲区（cache），提高了安全机制的运行性能。它提供了 hook 函数高效检查授权的接口，提供了安全服务器管理 cache 的接口。

#### 1. selinux运行模式

1. Enforcing 
   - 这个缺省模式会在系统上启用并实施selinux的安全策略，拒绝访问并记录行动
2. Permissive
   - selinux会被启用但不会实施安全性策略，只会发出警告以及记录行动，常被用于调试模式排查是否为selinux问题
3. Disabled
   - selinux已被停用

4. 配置文件：/etc/selinux/config 或 /etc/sysconfig/selinux， `SELINUX=enforcing`

#### 2. 安全策略类型

> targeted为默认类型，minimum和mls 稳定性不足，应用较少

1. targeted
   - 默认策略类型，采用mcs级别的安全策略。将系统进程分为两大类，一类运行在confined域，任何访问请求都会受到selinux的限制。另一类运行在unconfined域，不受selinux的约束
2. minimum
   - 是targeted的子集，只有指定的confined域的进程受到selinux的限制
3. mls
   - 所有进程都被划分为细粒度的安全域，受mls策略的限制。如果mls策略还采用了BLP（Bell And LaPadula模型，则所有进程还进一步收到数据安全的安全级别的限制），这是最严格的政策，配置难度非常大。（一般不用，除非对安全性有极高的要求。）
4. 配置文件：/etc/selinux/config 或 /etc/sysconfig/selinux，`SELINUXTYPE=targeted`

#### 3. 安全上下文

> 文件的安全上下文可以通过 ls -Z查看
>
> 进程的安全上下文可以通过 ps auxZ 查看
>
> 一个进程安全上下文一般对应多个文件安全上下文，只有两者的安全上下文对应上了，进程才能访问文件

1. 安全上下文五元素示例
   - `user:role:type:sensitivity`
2. user
   - 指登录系统的用户类型，如root、user_u、system_u,多数本地进程都属于自由（unconfined）进程

3. role
   - 定义文件、进程和用户的用途，文件：object_r，进程和用户：system_r
4. type
   - 指定数据类型，规则中定义何种进程类型访问何种文件target策略基于type实现，多服务共用：public_content_t, http服务：http_t
5. sensitivity
   - 限制访问的需要，由组织定义的分层安全级别，如uncalssified, secret,top,secret,一个对象有且只有一个sensitivity,分0-15级别，s0最低，target策略默认使用s0

#### 4. selinux的优势

- 控制范围覆盖文件系统、目录、文件、文件启动描述符、端口、消息接口和网络接口。
- 减少特权升级攻击的漏洞。进程在域中运行，并且每个进程都被隔离开来。
-  SELinux策略规则定义了进程如何访问文件和其他进程。如果一个进程受到攻击，攻击者只能访问该进程的正常功能。以及该进程已被配置为有权访问的文件。（例如，如果Apache HTTP服务器遭到入侵，攻击者无法使用该进程读取用户主目录中的文件，除非已添加或配置了特定的SELinux策略规则来允许此类访问）